flowplayer(function(api,root){"use strict";function hasABRSource(video){return video.sources.some(function(src){return/mpegurl/i.test(src.type)})}function canPlay(type){var videoTag=document.createElement("video");return!!videoTag.canPlayType(type).replace("no","")}function getQualityFromSrc(src,qualities){var m=/-(\d+p)(\.(mp4|webm))?$/.exec(src);if(m&&-1!==qualities.indexOf(m[1]))return m[1]}function removeAllQualityClasses(){api.qualities&&api.qualities.length&&api.qualities.forEach(function(quality){common.removeClass(root,"quality-"+quality)})}function findOptimalQuality(previousQuality,newQualities){if("abr"===previousQuality)return"abr";var ret,a=parseInt(previousQuality,0);return newQualities.forEach(function(quality,i){i!=newQualities.length-1||ret||(ret=quality),parseInt(quality)<=a&&parseInt(newQualities[i+1])>a&&(ret=quality)}),ret}function processClip(video,quality,clean){var re,changed=!1,isDefaultQuality=quality===api.defaultQuality,currentQuality=api.quality||Math.min(api.video.height,api.video.width)+"p";re=currentQuality===api.defaultQuality?/(.+?)((\.(mp4|webm)$|$))/:/(-\d+p)?((\.(mp4|webm)$|$))/;var newSources=video.sources.map(function(src){if("abr"===quality||clean&&isDefaultQuality||/mpegurl/i.test(src.type))return src;var n={type:src.type,src:src.src.replace(re,currentQuality===api.defaultQuality?"$1-"+quality+"$2":isDefaultQuality?"$2":"-"+quality+"$2")};return n.src!==src.src&&(changed=!0),n}),newSourcesStr=JSON.stringify(newSources);newSources.sort(function(a,b){var ret,re=/mpegurl/i;return ret="abr"===quality?re.test(b.type)-re.test(a.type):re.test(a.type)-re.test(b.type)}),changed=changed||JSON.stringify(newSources)!==newSourcesStr;var clip=flowplayer.extend({},video,{sources:newSources});return changed?clip:!1}var common=flowplayer.common,explicitSrc=!1;api.pluginQualitySelectorEnabled||(api.pluginQualitySelectorEnabled=!0,flowplayer.support.inlineVideo&&(api.conf.qualities&&(api.qualities="string"==typeof api.conf.qualities?api.conf.qualities.split(","):api.conf.qualities,api.defaultQuality=api.conf.defaultQuality),flowplayer.bean.on(root,"click",".fp-quality-selector li",function(ev){if(!/\bactive\b/.test(this.className)){var src,currentTime=api.finished?0:api.video.time,quality=ev.currentTarget.getAttribute("data-quality");if(src=processClip(api.video,quality),api.quality=quality,!src)return;explicitSrc=!0,api.load(src,function(){explicitSrc=!1,api.finished=!1,currentTime&&!api.live&&api.seek(currentTime,function(){api.resume()})})}}),api.bind("load",function(ev,api,video){if(api.qualities=video.qualities||api.qualities||[],api.defaultQuality=video.defaultQuality||api.defaultQuality,"string"==typeof api.qualities&&(api.qualities=api.qualities.split(",")),api.quality){var desiredQuality=findOptimalQuality(api.quality,api.qualities),newClip=processClip(video,desiredQuality,!explicitSrc);!explicitSrc&&newClip&&(ev.preventDefault(),api.loading=!1,api.load(newClip))}}),api.bind("ready",function(ev,api,video){var quality=/mpegurl/i.test(video.type)?"abr":getQualityFromSrc(video.src,api.qualities)||Math.min(video.height,video.width)+"p";removeAllQualityClasses(),api.quality=quality,common.addClass(root,"quality-"+quality);var ui=common.find(".fp-ui",root)[0];if(common.removeNode(common.find(".fp-quality-selector",ui)[0]),!(api.qualities.length<2)){var selector=common.createElement("ul",{"class":"fp-quality-selector"});ui.appendChild(selector),(hasABRSource(video)&&canPlay("application/x-mpegurl")||api.conf.swfHls)&&selector.appendChild(common.createElement("li",{"data-quality":"abr","class":"abr"===quality?"active":""},"Auto")),api.qualities.forEach(function(q){selector.appendChild(common.createElement("li",{"data-quality":q,"class":q==quality?"active":""},q))})}}),api.bind("unload",function(){removeAllQualityClasses(),common.removeNode(common.find(".fp-quality-selector",root)[0])})))});